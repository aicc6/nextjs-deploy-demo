pipeline {
    agent any

    // íŒŒë¼ë¯¸í„° ì •ì˜ (ìˆ˜ë™ ë¹Œë“œ ì‹œ ë¸Œëœì¹˜ ì„ íƒ ê°€ëŠ¥)
    parameters {
        choice(
            name: 'BRANCH_TO_BUILD',
            choices: ['develop', 'main', 'release/latest'],
            description: 'ë¹Œë“œí•  ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš” (GitHub Webhookì—ì„œëŠ” ìë™ ê°ì§€)'
        )
    }

    // ë¹Œë“œ íŠ¸ë¦¬ê±° ì„¤ì •
    triggers {
        githubPush()
    }

    // Jenkins Global Tool Configurationì—ì„œ ì„¤ì •í•œ ë„êµ¬ë“¤
    tools {
        nodejs 'node-v20.19.4'
    }

    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    environment {
        // Git Repository ì„¤ì • (Public Repository)
        GIT_REPOSITORY_URL = 'https://github.com/aicc6/nextjs-deploy-demo.git'

        // Docker Registry ì„¤ì •
        DOCKER_REGISTRY = "${env.CUSTOM_DOCKER_REGISTRY ?: 'nexus-docker.aicc-project.com'}"
        DOCKER_CREDENTIALS = "${env.CUSTOM_DOCKER_CREDENTIALS ?: 'nexus-docker-credentials'}"
        DOCKER_IMAGE = 'aicc/nextjs-deploy-demo'
        CONTAINER_NAME = 'nextjs-deploy-demo'

        // Node.js ì‹¤í–‰ í™˜ê²½ ì„¤ì •
        NODE_ENV = 'production'
    }

    // ë¹Œë“œ ì˜µì…˜
    options {
        buildDiscarder(logRotator(
            numToKeepStr: '10',
            daysToKeepStr: '30'
        ))
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
        timestamps()
    }

    stages {
        // 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ë° í™˜ê²½ ì„¤ì •
        stage('ğŸ”„ Clone Repository & Setup') {
            steps {
                script {
                    // ë¸Œëœì¹˜ ì •ë³´ í™•ì¸
                    def branchName = params.BRANCH_TO_BUILD ?: env.BRANCH_NAME ?: env.GIT_BRANCH ?: 'develop'

                    if (branchName?.startsWith('refs/heads/')) {
                        branchName = branchName.replace('refs/heads/', '')
                    }
                    if (branchName?.startsWith('origin/')) {
                        branchName = branchName.replace('origin/', '')
                    }

                    echo "ğŸ” ì²´í¬ì•„ì›ƒí•  ë¸Œëœì¹˜: ${branchName}"

                    // Git ì²´í¬ì•„ì›ƒ
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/${branchName}"]],
                        userRemoteConfigs: [[
                            url: "${env.GIT_REPOSITORY_URL}",
                            credentialsId: ''
                        ]],
                        extensions: [
                            [$class: 'CleanBeforeCheckout'],
                            [$class: 'CloneOption', depth: 1, shallow: true]
                        ]
                    ])

                    echo "âœ… Git ì²´í¬ì•„ì›ƒ ì™„ë£Œ: ${branchName}"
                }

                script {
                    echo "ğŸš€ Next.js Deploy Demo ë¹Œë“œ ì‹œì‘"
                    echo "ğŸ“‹ ë¸Œëœì¹˜: ${env.GIT_BRANCH}"
                    echo "ğŸ”– ì»¤ë°‹: ${env.GIT_COMMIT}"

                    // Git ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                }

                // í™˜ê²½ë³„ .env íŒŒì¼ ìƒì„±
                script {
                    def currentBranch = env.GIT_BRANCH ?: 'develop'
                    def envType = currentBranch.contains('main') ? 'production' : 'development'

                    echo "ğŸ”§ í™˜ê²½ ì„¤ì •: ${envType}"

                    // ê¸°ë³¸ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
                    sh """
                        echo "ğŸ“„ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘"
                        echo "NODE_ENV=${envType}" > .env.${envType}
                        echo "NEXT_PUBLIC_APP_ENV=${envType}" >> .env.${envType}
                        chmod 644 .env.${envType}
                        echo "âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ"
                    """
                }
            }
        }

        // 2. í™˜ê²½ ì„¤ì • í™•ì¸
        stage('ğŸ”§ Environment Setup') {
            steps {
                sh '''
                    echo "ğŸ“¦ Node.js ë²„ì „ í™•ì¸"
                    node --version
                    npm --version

                    echo "ğŸ³ Docker ë²„ì „ í™•ì¸"
                    docker --version
                '''
            }
        }

        // 3. ì˜ì¡´ì„± ì„¤ì¹˜
        stage('ğŸ“¦ Install Dependencies') {
            steps {
                sh '''
                    echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘"
                    rm -rf node_modules .next

                    npm ci --include=dev --no-audit --no-fund --prefer-offline --progress=false

                    # ì„¤ì¹˜ í™•ì¸
                    echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
                    echo "ğŸ“‹ Next.js í™•ì¸:"
                    ls -la node_modules/.bin/next || echo "Next.js ë°”ì´ë„ˆë¦¬ í™•ì¸ ì‹¤íŒ¨"
                    echo "ğŸ“‹ TypeScript í™•ì¸:"
                    ls -la node_modules/.bin/tsc || echo "TypeScript ë°”ì´ë„ˆë¦¬ í™•ì¸ ì‹¤íŒ¨"
                '''
            }
        }

        // 4. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
        stage('ğŸ” Code Quality') {
            steps {
                script {
                    echo "ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹œì‘"

                    def lintResult = sh(
                        script: '''
                            echo "ğŸ“ ESLint ì‹¤í–‰"
                            npm run lint || true
                        ''',
                        returnStatus: true
                    )

                    if (lintResult != 0) {
                        echo "âš ï¸ ESLintì—ì„œ ê²½ê³  ë°œê²¬ (ë°°í¬ëŠ” ê³„ì† ì§„í–‰)"
                        currentBuild.result = 'UNSTABLE'
                    } else {
                        echo "âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼"
                    }
                }
            }
        }

        // 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        stage('ğŸ—ï¸ Build Application') {
            steps {
                sh '''
                    echo "ğŸ—ï¸ Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì‹œì‘"
                    npm run build

                    echo "âœ… ë¹Œë“œ ì™„ë£Œ"
                    echo "ğŸ“¦ ë¹Œë“œ ê²°ê³¼:"
                    ls -la .next/
                '''
            }
        }

        // 6. Docker ì´ë¯¸ì§€ ë¹Œë“œ
        stage('ğŸ³ Build Docker Image') {
            steps {
                script {
                    echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"

                    try {
                        def app = docker.build("${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}")
                        env.DOCKER_BUILD_SUCCESS = 'true'

                        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ"
                        echo "ğŸ“¦ ì´ë¯¸ì§€: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}"
                    } catch (Exception e) {
                        env.DOCKER_BUILD_SUCCESS = 'false'
                        error "Docker ë¹Œë“œ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }

        // 7. Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        stage('ğŸ“¤ Push Docker Image') {
            when {
                environment name: 'DOCKER_BUILD_SUCCESS', value: 'true'
            }
            steps {
                script {
                    try {
                        docker.withRegistry("https://${DOCKER_REGISTRY}", "${DOCKER_CREDENTIALS}") {
                            def app = docker.image("${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}")
                            app.push("${BUILD_NUMBER}")

                            // main ë¸Œëœì¹˜ëŠ” latest íƒœê·¸ë„ í‘¸ì‹œ
                            def currentBranch = env.GIT_BRANCH ?: 'develop'
                            if (currentBranch.contains('main')) {
                                app.push("latest")
                                echo "âœ… latest íƒœê·¸ í‘¸ì‹œ ì™„ë£Œ"
                            }
                        }

                        env.DOCKER_PUSH_SUCCESS = 'true'
                        echo "âœ… Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì„±ê³µ: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}"
                    } catch (Exception e) {
                        error "Docker í‘¸ì‹œ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }

        // 8. Docker ì»¨í…Œì´ë„ˆ ë°°í¬
        stage('ğŸš€ Deploy') {
            when {
                environment name: 'DOCKER_PUSH_SUCCESS', value: 'true'
            }
            steps {
                script {
                    def currentBranch = env.GIT_BRANCH ?: 'develop'
                    def deployEnv = currentBranch.contains('main') ? 'production' : 'development'
                    def containerName = "${CONTAINER_NAME}-${deployEnv}"
                    def containerPort = deployEnv == 'production' ? '3000' : '3001'
                    def dockerNetwork = 'demo-net'

                    echo "ğŸš€ ë°°í¬ ì‹œì‘: ${deployEnv} í™˜ê²½"
                    echo "ğŸ“¦ ì»¨í…Œì´ë„ˆ: ${containerName}"
                    echo "ğŸ”Œ í¬íŠ¸: ${containerPort}"
                    echo "ğŸ“¦ ì´ë¯¸ì§€: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}"

                    sh """
                        # ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                        docker pull ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}

                        # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
                        docker stop ${containerName} || true
                        docker rm ${containerName} || true

                        # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                        docker run -d \\
                            --name ${containerName} \\
                            --network ${dockerNetwork} \\
                            --restart unless-stopped \\
                            --label "app=nextjs-deploy-demo" \\
                            --label "env=${deployEnv}" \\
                            --label "version=${BUILD_NUMBER}" \\
                            ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}

                        # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
                        sleep 5
                        docker ps | grep ${containerName}
                        echo "âœ… ì»¨í…Œì´ë„ˆ ${containerName} ë°°í¬ ì™„ë£Œ"
                    """

                    // ë°°í¬ í›„ í—¬ìŠ¤ ì²´í¬
                    sh """
                        echo "ğŸ” í—¬ìŠ¤ ì²´í¬ ì‹œì‘"
                        sleep 10
                        for i in {1..10}; do
                            if curl -f http://localhost:${containerPort} > /dev/null 2>&1; then
                                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
                                break
                            else
                                echo "â³ ëŒ€ê¸° ì¤‘... (${i}/10)"
                                sleep 3
                            fi
                        done
                    """
                }
            }
        }
    }

    // ë¹Œë“œ í›„ ì‘ì—…
    post {
        always {
            echo "ğŸ“‹ ë¹Œë“œ í›„ ì •ë¦¬ ì‘ì—…"

            script {
                try {
                    sh 'docker system prune -f'
                } catch (Exception e) {
                    echo "Docker ì •ë¦¬ ì‹¤íŒ¨: ${e.getMessage()}"
                }
            }

            cleanWs()
        }

        success {
            echo 'âœ… íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!'
            echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ì†: http://localhost:${env.GIT_BRANCH?.contains('main') ? '3000' : '3001'}"
        }

        failure {
            echo 'âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!'

            script {
                // ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
                sh '''
                    echo "ğŸ” ë””ë²„ê¹… ì •ë³´:"
                    docker ps -a | grep nextjs-deploy-demo || echo "ê´€ë ¨ ì»¨í…Œì´ë„ˆ ì—†ìŒ"
                    docker images | grep nextjs-deploy-demo || echo "ê´€ë ¨ ì´ë¯¸ì§€ ì—†ìŒ"
                '''
            }
        }

        unstable {
            echo 'âš ï¸ íŒŒì´í”„ë¼ì¸ ë¶ˆì•ˆì • (ì½”ë“œ í’ˆì§ˆ ê²½ê³ )'
        }
    }
}